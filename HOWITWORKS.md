# Реверс-инженерим API АСУ РСО

Здесь описаны мои заметки о том, как работает их апи. Очень надеюсь, команда разработчиков не увидит эту библиотеку и не поменяет ничего :)

**⚠️ ВАЖНО! Это не документация пакета, если вы просто хотите использовать библиотеку, перейдите на страницу [README.md](README.md)⚠️**

## Вход в аккаунт

Авторизация всех запросов базируется всего на двух ключах: куки ESRNSec и заголовок at. Оба получаются во время авторизации с помощью логина и пароля. Лезть в госуслуги я не хочу и не буду, может после того как уеду из России попробую описать их апи.

Для авторизации нужно:

1. Сделать POST запрос на `https://asurso.ru/webapi/auth/getdata`

Мы получим ответ в JSON и куки `NSSESSIONID`

```
{
    "lt": "число 1*",
    "ver": "число 2*",
    "salt": "число 3*"
}
```

2. Сделать POST запрос на `https://asurso.ru/webapi/login` с куки `NSSESSIONID` и телом в x-www-form-urlencoded в следующем формате:

```
LoginType: 1
cid: [id страны, всегда 2]
sid: [id региона]
pid: [id округа/района]
cn: [id города]
sft: [id ТИПА образовательной организации]
scid: [id образовательной организации]
UN: [логин, строка]
PW: [первые 9 символов хеша пароля]
lt: [число 1*]
pw2: [полный хеш пароля]
ver: [число 2*]
```

**Все ID вы можете найти в файле [LOGINIDS.md](LOGINIDS.md)**

Чтобы получить значения полей PW и pw2 необходимо взять ваш пароль, хешировать его с MD5, а затем вначале конкатенировать к нему полученную в 1 шаге соль (число 3*) и снова хешировать. Таким образом полностью алгоритм будет выглядеть так:

`pw2 = md5((число 3*) + md5(password))`

Зачем хешировать пароль на фронтенде лучше спросите разработчика tls и асурсо)

3. В ответ мы получим JSON следующего вида:

```
{
  "at": "[число at]",
  "code": null,
  "timeOut": 3600000,
  "accessToken": "...",
  "refreshToken": "...",
  "accountInfo": {
    "activeToken": null,
    "secureActiveToken": "...",
    "currentOrganization": {
      "id": ...,
      "name": "..."
    },
    "user": {
      "id": ...,
      "name": "..."
    },
    "userRoles": [],
    "organizations": [
      {
        "id": ...,
        "name": "..."
      },
      {
        "id": ...,
        "name": "..."
      }
    ],
    "loginTime": "2022-01-13T22:37:38.7883797",
    "active": true,
    "canLogin": true,
    "storeTokens": true,
    "accessToken": "..."
  },
  "tokenType": "Bearer",
  "entryPoint": "/asp/SecurityWarning.asp",
  "requestData": {
    "warnType": "1"
  },
  "errorMessage": null
}
```

Отсюда нам нужно лишь число at, его очень важно сохранить, ведь без него вы не сможете делать ни один запрос. Более того, оно используется в браузере, ведь когда вы входите в систему это число будет постоянно с вами, а при переходе вы делаете не GET а POST запрос. Мне такая логика кажется очень странной, ведь если обновить страницу, число потеряется из-за удаления сессии в браузере, но не на бекенде.

Короче, забирайте "at" и идем дальше.

**Куки ESRNSec ставится самим запросом (заголовок set-cookie). Самостоятельно генерировать ничего не нужно, просто сохраните значение.**

